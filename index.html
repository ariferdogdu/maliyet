<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1200">
<title>Erdoğdular İnşaat | İnşaat Maliyet Takip</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{font-family:Arial;background:#0b0f14;color:white;margin:0}
.wrapper{width:1200px;margin:20px auto}
h1{text-align:center}
input,button{padding:8px;margin:5px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #333;padding:8px;text-align:center}
.toplam{font-size:20px;font-weight:bold;text-align:right;margin-top:10px;color:#22c55e}
</style>
</head>
<body>
<div class="wrapper">
<h1>ERDOĞDULAR İNŞAAT - MALİYET TAKİP</h1>

<input type="date" id="tarih">
<input type="text" id="kalem" placeholder="Kalem">
<input type="number" id="tutar" placeholder="Tutar">
<button onclick="ekle()">Kaydet</button>
<button onclick="pdfAl()">PDF Kaydet</button>

<table>
<thead>
<tr>
<th>Tarih</th>
<th>Kalem</th>
<th>Tutar</th>
<th>İşlem</th>
</tr>
</thead>
<tbody id="liste"></tbody>
</table>

<div class="toplam">
TOPLAM: <span id="toplam">0</span> TL
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  doc, deleteDoc, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";


const firebaseConfig = {
  apiKey: "AIzaSyALlObtK9SA_47iX1H8ZMtFPNtxo0b3pgI",
  authDomain: "erdogdular-maliyet.firebaseapp.com",
  projectId: "erdogdular-maliyet",
  storageBucket: "erdogdular-maliyet.firebasestorage.app",
  messagingSenderId: "683761580398",
  appId: "1:683761580398:web:c903bd6b99e6f38904a97f"
};


const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

await signInAnonymously(auth);

let veriler = [];

function formatTL(sayi){ return Number(sayi).toLocaleString('tr-TR'); }

function goster(){
  let liste=document.getElementById("liste");
  liste.innerHTML="";
  let toplam=0;
  veriler.forEach(v=>{
    toplam+=Number(v.tutar);
    liste.innerHTML+=`
      <tr>
        <td>${v.tarih}</td>
        <td>${v.kalem}</td>
        <td>${formatTL(v.tutar)} TL</td>
        <td><button onclick="sil('${v.id}')">Sil</button></td>
      </tr>`;
  });
  document.getElementById("toplam").innerText=formatTL(toplam);
}

const q = query(collection(db,"maliyet"), orderBy("createdAt","asc"));
onSnapshot(q,(snap)=>{
  veriler = snap.docs.map(d=>({id:d.id,...d.data()}));
  goster();
});

window.ekle = async function(){
  let tarih=document.getElementById("tarih").value;
  let kalem=document.getElementById("kalem").value;
  let tutar=document.getElementById("tutar").value;
  if(!tarih||!kalem||!tutar) return alert("Boş alan bırakma");
  await addDoc(collection(db,"maliyet"),{tarih,kalem,tutar,createdAt:serverTimestamp()});
  document.getElementById("kalem").value="";
  document.getElementById("tutar").value="";
}

window.sil = async function(id){
  await deleteDoc(doc(db,"maliyet",id));
}

window.pdfAl = function(){ html2pdf().from(document.body).save("maliyet.pdf"); }
</script>
</body>
</html>
